# Javascript Node CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-javascript/ for more details
#
version: 2
jobs:
  build:
    machine:
      image: circleci/classic:edge
    working_directory: ~/test
    steps:
      - checkout
      - run:
          command: |
            curl $SLACK_WEBHOOK \
            -s \
            -X POST \
            -H "Content-Type: application/json" \
            -d "{ \"text\": \":arrow_forward: ${CIRCLE_BRANCH} of https://circleci.com/gh/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}\n> COVERAGE: *$(curl https://codecov.io/gh/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/branch/master/graph/badge.txt)%* https://codecov.io/gh/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}\n> STATUS: https://circleci.com/gh/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}.png?r=$(cat /dev/urandom | base64 | fold -w 10 | head -n 1)\" } >/dev/null 2>&1"
      - run:
          name: Install Docker Compose
          command: |
            curl -L https://github.com/docker/compose/releases/download/1.19.0/docker-compose-`uname -s`-`uname -m` > ~/docker-compose
            chmod +x ~/docker-compose
            sudo mv ~/docker-compose /usr/local/bin/docker-compose
      - run:
          name: docker-compose up
          command: |
            set -x
            docker-compose up --build -d
      - run:
          name: lint for express
          command: |
            set -x
            docker-compose exec app yarn lint-express
      - run:
          name: lint for vue
          command: |
            set -x
            docker-compose exec app yarn lint-vue
      - run:
          name: test for express
          command: |
            set -x
            docker-compose exec app yarn test-express
      - run:
          name: test for vue
          command: |
            set -x
            docker-compose exec app yarn test-vue
      - run:
          name: set codecov env
          command: |
            set -x
            docker-compose exec app export
      - run:
          name: codecov for express
          command: |
            set -x
            docker-compose exec app yarn codecov-express
      - run:
          name: codecov for vue
          command: |
            set -x
            docker-compose exec app yarn codecov-vue
      - run:
          name: build for express
          command: |
            set -x
            docker-compose exec app yarn build-express
      - run:
          name: build for vue
          command: |
            set -x
            docker-compose exec app yarn build-vue
      - run:
          name: docker-compose down
          command: docker-compose down
      - run:
          command: |
            curl $SLACK_WEBHOOK \
            -s \
            -X POST \
            -H "Content-Type: application/json" \
            -d "{ \"text\": \":tada: ${CIRCLE_BRANCH} of https://circleci.com/gh/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}\n> COVERAGE: *$(sleep 3 && curl https://codecov.io/gh/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/branch/master/graph/badge.txt)%* https://codecov.io/gh/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}\n> STATUS: https://circleci.com/gh/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}.png?r=$(cat /dev/urandom | base64 | fold -w 10 | head -n 1)\" } >/dev/null 2>&1"
      - run:
          command: |
            curl $SLACK_WEBHOOK \
            -s \
            -X POST \
            -H "Content-Type: application/json" \
            -d "{ \"text\": \":boom: ${CIRCLE_BRANCH} of https://circleci.com/gh/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}\n> COVERAGE: *$(curl https://codecov.io/gh/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/branch/master/graph/badge.txt)%* https://codecov.io/gh/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}\n> STATUS: https://circleci.com/gh/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}.png?r=$(cat /dev/urandom | base64 | fold -w 10 | head -n 1)\" } >/dev/null 2>&1"
          when: on_fail
